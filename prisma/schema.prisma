generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SourceSystem {
  KNACK
  CSV
  MANUAL
  API
}

enum TestType {
  ICP
  ANTIBACTERIAL
  FUNGAL
  ODOR
  OTHER
}

enum DocKind {
  REPORT
  IMAGE
  SUBMISSION_DOC
  OTHER
}

model SourceRecord {
  id             String       @id @default(cuid())
  sourceSystem   SourceSystem @default(CSV)
  sourceTable    String
  sourceRecordId String? // e.g., Knack "Record ID"
  sourceKey      String? // e.g., file row key, composite identifiers
  raw            Json // entire raw row (verbatim)
  importedAt     DateTime     @default(now())

  // Optional links (set during import if resolvable)
  brandId      String?
  factoryId    String?
  labId        String?
  submissionId String?
  testRunId    String?

  brand      Brand?            @relation(fields: [brandId], references: [id])
  factory    Factory?          @relation(fields: [factoryId], references: [id])
  lab        Lab?              @relation(fields: [labId], references: [id])
  submission FabricSubmission? @relation(fields: [submissionId], references: [id])
  testRun    TestRun?          @relation(fields: [testRunId], references: [id])

  @@index([sourceTable])
  @@index([sourceRecordId])
  @@index([brandId])
  @@index([factoryId])
  @@index([labId])
  @@index([submissionId])
  @@index([testRunId])
}

model Brand {
  id                 String    @id @default(cuid())
  name               String    @unique
  customerType       String?
  status             String?
  leadSource         String?
  initialContactDate DateTime?
  addressRaw         String?

  // raw capture for “store both”
  raw Json?

  contacts      Contact[]
  submissions   FabricSubmission[]
  sourceRecords SourceRecord[] // ✅ added

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Factory {
  id                 String    @id @default(cuid())
  name               String
  chineseName        String?
  millType           String?
  specialty          String?
  annualSales        String?
  leadSource         String?
  initialContactDate DateTime?

  addressRaw String?
  raw        Json?

  contacts      Contact[]
  submissions   FabricSubmission[]
  sourceRecords SourceRecord[] // ✅ added

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model Distributor {
  id           String  @id @default(cuid())
  name         String
  chineseName  String?
  specialty    String?
  agentForFuze String?
  annualSales  String?

  addressRaw String?
  raw        Json?

  contacts Contact[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model Lab {
  id   String @id @default(cuid())
  name String @unique
  raw  Json?

  testRuns      TestRun[]
  sourceRecords SourceRecord[] // ✅ added (fixes your error)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contact {
  id         String  @id @default(cuid())
  first      String?
  middle     String?
  last       String?
  title      String?
  email      String?
  phone      String?
  addressRaw String?

  raw Json?

  // a contact can belong to one of these
  brandId       String?
  factoryId     String?
  distributorId String?

  brand       Brand?       @relation(fields: [brandId], references: [id])
  factory     Factory?     @relation(fields: [factoryId], references: [id])
  distributor Distributor? @relation(fields: [distributorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([last])
}

model Fabric {
  id String @id @default(cuid())

  // Canonical “fabric concept” fields (normalized)
  construction String?
  color        String?
  widthInches  Float?
  weightGsm    Float?

  contents FabricContent[]

  // raw capture
  raw Json?

  submissions FabricSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FabricContent {
  id       String  @id @default(cuid())
  fabricId String
  material String
  percent  Float?
  rawText  String?

  fabric Fabric @relation(fields: [fabricId], references: [id])

  @@index([fabricId])
}

model FabricSubmission {
  id String @id @default(cuid())

  // Links
  brandId   String?
  factoryId String?
  fabricId  String?

  brand   Brand?   @relation(fields: [brandId], references: [id])
  factory Factory? @relation(fields: [factoryId], references: [id])
  fabric  Fabric?  @relation(fields: [fabricId], references: [id])

  // Submission identifiers (raw + normalized)
  fuzeFabricNumber   Int?
  customerFabricCode String?
  factoryFabricCode  String?

  // Application / process
  applicationMethod    String?
  applicationRecipeRaw String?
  padRecipeRaw         String?
  treatmentLocation    String?
  applicationDate      DateTime?

  washTarget Int?

  // Status flags
  icpSent     Boolean?
  icpReceived Boolean?
  icpPassed   Boolean?
  abSent      Boolean?
  abReceived  Boolean?
  abPassed    Boolean?

  category    String?
  programName String?

  raw Json?

  testRuns      TestRun[]
  documents     Document[]
  sourceRecords SourceRecord[] // ✅ added (fixes your error)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fuzeFabricNumber])
  @@index([customerFabricCode])
  @@index([factoryFabricCode])
}

model TestRun {
  id String @id @default(cuid())

  submissionId String?
  labId        String?

  submission FabricSubmission? @relation(fields: [submissionId], references: [id])
  lab        Lab?              @relation(fields: [labId], references: [id])

  testType         TestType
  testMethodRaw    String?
  testMethodStd    String?
  testReportNumber String?

  testDate     DateTime?
  postWashDate DateTime?
  washCount    Int?
  washLabelRaw String?

  machineType String?
  testedMetal String?

  raw Json?

  icpResult IcpResult?
  abResult  AntibacterialResult?

  documents     Document[]
  sourceRecords SourceRecord[] // ✅ added (fixes your error)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([testType])
  @@index([testMethodStd])
  @@index([washCount])
  @@index([testDate])
}

model IcpResult {
  id        String  @id @default(cuid())
  testRunId String  @unique
  testRun   TestRun @relation(fields: [testRunId], references: [id])

  agValue Float?
  auValue Float?

  agRaw String?
  auRaw String?

  unit String?
}

model AntibacterialResult {
  id        String  @id @default(cuid())
  testRunId String  @unique
  testRun   TestRun @relation(fields: [testRunId], references: [id])

  organism1 String?
  organism2 String?

  result1 Float?
  result2 Float?

  organism1Raw String?
  organism2Raw String?
  result1Raw   String?
  result2Raw   String?

  pass Boolean?
}

model Document {
  id String @id @default(cuid())

  kind        DocKind @default(REPORT)
  filename    String?
  contentType String?
  sizeBytes   Int?

  // S3 pointers
  bucket String?
  key    String? @unique
  url    String?

  // Links
  submissionId String?
  testRunId    String?

  submission FabricSubmission? @relation(fields: [submissionId], references: [id])
  testRun    TestRun?          @relation(fields: [testRunId], references: [id])

  raw Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([submissionId])
  @@index([testRunId])
}
