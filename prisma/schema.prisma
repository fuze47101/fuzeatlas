generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// ENUMS
// ─────────────────────────────────────────────

enum SourceSystem {
  KNACK
  CSV
  MANUAL
  API
}

enum PipelineStage {
  LEAD
  PRESENTATION
  BRAND_TESTING
  FACTORY_ONBOARDING
  FACTORY_TESTING
  PRODUCTION
  BRAND_EXPANSION
  ARCHIVE
  CUSTOMER_WON
}

enum TestType {
  ICP
  ANTIBACTERIAL
  FUNGAL
  ODOR
  UV
  MICROFIBER
  OTHER
}

enum TestStatus {
  REQUESTED
  IN_PROGRESS
  PASSED
  FAILED
  RETEST
  PASSED_COMPLETE
}

enum DocKind {
  REPORT
  IMAGE
  SUBMISSION_DOC
  SOW_DOC
  OTHER
}

enum SOWStatus {
  DRAFT
  SENT
  SIGNED
  ACTIVE
  COMPLETE
  CANCELLED
}

enum UserRole {
  ADMIN
  EMPLOYEE
  SALES_MANAGER
  SALES_REP
  FABRIC_MANAGER
  TESTING_MANAGER
  FACTORY_MANAGER
  FACTORY_USER
  BRAND_USER
  DISTRIBUTOR_USER
  PUBLIC
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
}

// ─────────────────────────────────────────────
// AUDIT / IMPORT TRACKING
// ─────────────────────────────────────────────

model SourceRecord {
  id             String       @id @default(cuid())
  sourceSystem   SourceSystem @default(CSV)
  sourceTable    String
  sourceRecordId String?
  sourceKey      String?
  raw            Json
  importedAt     DateTime     @default(now())

  brandId      String?
  factoryId    String?
  labId        String?
  submissionId String?
  testRunId      String?
  distributorId  String?

  brand      Brand?            @relation(fields: [brandId], references: [id])
  factory    Factory?          @relation(fields: [factoryId], references: [id])
  lab        Lab?              @relation(fields: [labId], references: [id])
  submission FabricSubmission? @relation(fields: [submissionId], references: [id])
  testRun    TestRun?          @relation(fields: [testRunId], references: [id])
  distributor Distributor?      @relation(fields: [distributorId], references: [id])

  @@index([sourceSystem, sourceTable])
  @@index([sourceRecordId])
}

// ─────────────────────────────────────────────
// USERS & AUTH
// ─────────────────────────────────────────────

model User {
  id       String     @id @default(cuid())
  name     String
  email    String     @unique
  password String?
  role     UserRole   @default(PUBLIC)
  status   UserStatus @default(ACTIVE)

  salesManagerId String?
  salesManager   User?   @relation("SalesManagerReps", fields: [salesManagerId], references: [id])
  managedReps    User[]  @relation("SalesManagerReps")

  brandId       String?
  brand         Brand?       @relation("BrandUsers", fields: [brandId], references: [id])
  factoryId     String?
  factory       Factory?     @relation("FactoryUsers", fields: [factoryId], references: [id])
  distributorId String?
  distributor   Distributor? @relation("DistributorUsers", fields: [distributorId], references: [id])

  assignedBrands    Brand[]    @relation("BrandSalesRep")
  assignedFactories Factory[]  @relation("FactorySalesRep")

  notes     Note[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
  @@index([email])
}

// ─────────────────────────────────────────────
// BRANDS / CUSTOMERS
// ─────────────────────────────────────────────

model Brand {
  id     String @id @default(cuid())
  name   String @unique
  knackId String? @unique

  pipelineStage      PipelineStage @default(LEAD)
  customerType       String?
  leadReferralSource String?
  dateOfInitialContact DateTime?

  website        String?
  linkedInProfile String?
  backgroundInfo String?

  projectType        String?
  projectDescription String?
  presentationDate   DateTime?
  forecast           String?
  deliverables       String?

  raw Json?

  salesRepId String?
  salesRep   User?  @relation("BrandSalesRep", fields: [salesRepId], references: [id])

  contacts    Contact[]
  factories   BrandFactory[]
  submissions FabricSubmission[]
  fabrics     Fabric[]
  sows        SOW[]
  notes       Note[]
  users       User[]         @relation("BrandUsers")
  sourceRecords SourceRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pipelineStage])
  @@index([name])
}

// ─────────────────────────────────────────────
// FACTORIES / TEXTILE MILLS
// ─────────────────────────────────────────────

model Factory {
  id      String @id @default(cuid())
  name    String
  knackId String? @unique

  chineseName  String?
  millType     String?
  specialty    String?
  purchasing   String?
  annualSales  String?

  address          String?
  city             String?
  state            String?
  country          String?
  secondaryCountry String?

  development          String?
  presentationComplete Boolean?
  customerType         String?
  brandNominated       String?

  raw Json?

  salesRepId String?
  salesRep   User?  @relation("FactorySalesRep", fields: [salesRepId], references: [id])

  contacts      Contact[]
  brands        BrandFactory[]
  submissions   FabricSubmission[]
  fabrics       Fabric[]
  users         User[]         @relation("FactoryUsers")
  sourceRecords SourceRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([country])
}

model BrandFactory {
  id        String  @id @default(cuid())
  brandId   String
  factoryId String
  brand     Brand   @relation(fields: [brandId], references: [id])
  factory   Factory @relation(fields: [factoryId], references: [id])

  isPrimary Boolean @default(false)
  note      String?

  createdAt DateTime @default(now())

  @@unique([brandId, factoryId])
  @@index([brandId])
  @@index([factoryId])
}

// ─────────────────────────────────────────────
// DISTRIBUTORS
// ─────────────────────────────────────────────

model Distributor {
  id      String @id @default(cuid())
  name    String
  knackId String? @unique

  chineseName  String?
  specialty    String?
  agentForFuze String?
  annualSales  String?
  country      String?

  raw Json?

  contacts      Contact[]
  users         User[]         @relation("DistributorUsers")
  sourceRecords SourceRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────
// LABS
// ─────────────────────────────────────────────

model Lab {
  id      String @id @default(cuid())
  name    String @unique
  knackId String? @unique

  raw Json?

  testRuns      TestRun[]
  sourceRecords SourceRecord[]
}

// ─────────────────────────────────────────────
// CONTACTS
// ─────────────────────────────────────────────

model Contact {
  id String @id @default(cuid())

  title      String?
  firstName  String?
  middleName String?
  lastName   String?
  name       String?

  email   String?
  phone   String?
  address String?

  brandId       String?
  factoryId     String?
  distributorId String?

  brand       Brand?       @relation(fields: [brandId], references: [id])
  factory     Factory?     @relation(fields: [factoryId], references: [id])
  distributor Distributor? @relation(fields: [distributorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([factoryId])
}

// ─────────────────────────────────────────────
// FABRICS
// ─────────────────────────────────────────────

model Fabric {
  id String @id @default(cuid())

  fuzeNumber   Int?    @unique
  customerCode String?
  factoryCode  String?

  construction String?
  color        String?
  weightGsm    Float?
  fullWidth    String?
  yarnType     String?
  finishNote   String?
  note         String?

  brandId   String?
  factoryId String?
  brand     Brand?   @relation(fields: [brandId], references: [id])
  factory   Factory? @relation(fields: [factoryId], references: [id])

  raw Json?

  contents    FabricContent[]
  submissions FabricSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fuzeNumber])
  @@index([customerCode])
  @@index([factoryCode])
  @@index([brandId])
  @@index([factoryId])
}

model FabricContent {
  id       String @id @default(cuid())
  fabricId String
  fabric   Fabric @relation(fields: [fabricId], references: [id])

  material      String
  percent       Float?
  rawText       String?

  @@index([fabricId])
  @@index([material])
}

// ─────────────────────────────────────────────
// MATERIAL NORMALIZATION
// ─────────────────────────────────────────────

model MaterialAlias {
  id            String @id @default(cuid())
  alias         String @unique
  canonicalName String

  @@index([canonicalName])
}

// ─────────────────────────────────────────────
// FABRIC SUBMISSIONS (fabric + treatment context)
// ─────────────────────────────────────────────

model FabricSubmission {
  id String @id @default(cuid())

  brandId   String?
  factoryId String?
  fabricId  String?

  brand   Brand?   @relation(fields: [brandId], references: [id])
  factory Factory? @relation(fields: [factoryId], references: [id])
  fabric  Fabric?  @relation(fields: [fabricId], references: [id])

  fuzeFabricNumber   Int?
  customerFabricCode String?
  factoryFabricCode  String?

  applicationMethod    String?
  applicationRecipeRaw String?
  padRecipeRaw         String?
  treatmentLocation    String?
  applicationDate      DateTime?

  washTarget Int?

  status           String?
  programName      String?
  developmentStage String?
  testStatus       String?
  category         String?

  icpSent     Boolean?
  icpReceived Boolean?
  icpPassed   Boolean?

  abSent      Boolean?
  abReceived  Boolean?
  abPassed    Boolean?

  progressPercent Float?

  raw Json?

  testRuns      TestRun[]
  documents     Document[]
  sourceRecords SourceRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fuzeFabricNumber])
  @@index([customerFabricCode])
  @@index([factoryFabricCode])
  @@index([status])
  @@index([testStatus])
}

// ─────────────────────────────────────────────
// TEST RUNS & RESULTS
// ─────────────────────────────────────────────

model TestRun {
  id String @id @default(cuid())

  submissionId String?
  labId        String?

  submission FabricSubmission? @relation(fields: [submissionId], references: [id])
  lab        Lab?              @relation(fields: [labId], references: [id])

  testNumber       Int?
  testType         TestType
  testMethodRaw    String?
  testMethodStd    String?
  testReportNumber String?
  fuzeInternalReportNumber String?
  postWashReportNumber     String?

  testDate     DateTime?
  postWashDate DateTime?

  washCount    Int?
  washLabelRaw String?

  machineType String?
  testedMetal String?

  agSerialNumber     String?
  auSerialNumber     String?
  fungalSerialNumber String?

  raw Json?

  icpResult    IcpResult?
  abResult     AntibacterialResult?
  fungalResult FungalResult?
  odorResult   OdorResult?

  documents     Document[]
  sourceRecords SourceRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([testType])
  @@index([testMethodStd])
  @@index([washCount])
  @@index([testDate])
  @@index([submissionId])
}

model IcpResult {
  id        String  @id @default(cuid())
  testRunId String  @unique
  testRun   TestRun @relation(fields: [testRunId], references: [id])

  agValue Float?
  auValue Float?

  agRaw String?
  auRaw String?
  unit  String?
}

model AntibacterialResult {
  id        String  @id @default(cuid())
  testRunId String  @unique
  testRun   TestRun @relation(fields: [testRunId], references: [id])

  organism1    String?
  organism2    String?
  result1      Float?
  result2      Float?
  organism1Raw String?
  organism2Raw String?
  result1Raw   String?
  result2Raw   String?
  pass         Boolean?
}

model FungalResult {
  id        String  @id @default(cuid())
  testRunId String  @unique
  testRun   TestRun @relation(fields: [testRunId], references: [id])

  writtenResult String?
  pass          Boolean?
  raw           String?
}

model OdorResult {
  id        String  @id @default(cuid())
  testRunId String  @unique
  testRun   TestRun @relation(fields: [testRunId], references: [id])

  testedOdor String?
  result     String?
  pass       Boolean?
}

// ─────────────────────────────────────────────
// SOW (Scope of Work)
// ─────────────────────────────────────────────

model SOW {
  id      String    @id @default(cuid())
  brandId String
  brand   Brand     @relation(fields: [brandId], references: [id])

  title               String?
  expectations        String?
  performanceCriteria String?
  pricingTerms        String?
  costControls        String?

  signatory      String?
  signatoryTitle String?
  signatoryEmail String?

  status SOWStatus @default(DRAFT)

  milestones SOWMilestone[]
  documents  Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([status])
}

model SOWMilestone {
  id    String @id @default(cuid())
  sowId String
  sow   SOW    @relation(fields: [sowId], references: [id])

  title       String
  description String?
  dueDate     DateTime?
  completedAt DateTime?
  sortOrder   Int       @default(0)

  @@index([sowId])
}

// ─────────────────────────────────────────────
// DOCUMENTS / ATTACHMENTS
// ─────────────────────────────────────────────

model Document {
  id String @id @default(cuid())

  kind        DocKind @default(REPORT)
  filename    String?
  contentType String?
  sizeBytes   Int?

  bucket String?
  key    String? @unique
  url    String?

  submissionId String?
  testRunId    String?
  sowId        String?

  submission FabricSubmission? @relation(fields: [submissionId], references: [id])
  testRun    TestRun?          @relation(fields: [testRunId], references: [id])
  sow        SOW?              @relation(fields: [sowId], references: [id])

  raw Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([submissionId])
  @@index([testRunId])
  @@index([sowId])
}

// ─────────────────────────────────────────────
// NOTES / ACTIVITY LOG
// ─────────────────────────────────────────────

model Note {
  id String @id @default(cuid())

  date     DateTime?
  content  String
  noteType String?

  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id])
  userId  String?
  user    User?   @relation(fields: [userId], references: [id])

  contactName String?
  taskStatus  String?

  createdAt DateTime @default(now())

  @@index([brandId])
  @@index([date])
}